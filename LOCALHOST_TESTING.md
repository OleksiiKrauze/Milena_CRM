# Тестирование Push-уведомлений на Localhost

## ✅ Что уже настроено

1. ✅ Backend пересобран с зависимостями `py-vapid` и `pywebpush`
2. ✅ VAPID ключи сгенерированы и добавлены в `.env`
3. ✅ Миграция применена (таблицы созданы)
4. ✅ Frontend зависимости установлены
5. ✅ Backend запущен на http://localhost:8000

---

## Запуск Frontend dev сервера

Откройте новый терминал и выполните:

```bash
cd "D:\1. Projects\MilenaCRM\frontend"
npm run dev
```

Frontend запустится на **http://localhost:5173**

---

## Тестирование Push-уведомлений

### 1. Войти в систему

1. Откройте http://localhost:5173
2. Войдите под пользователем, у которого есть роль с permission `cases:read` или `field_searches:read`

**Пример:** Администратор обычно имеет все permissions.

---

### 2. Включить уведомления

1. В навигации кликните на **иконку пользователя** (справа вверху)
2. Выберите **"Профіль"**
3. Прокрутите вниз до секции **"Push-сповіщення"**
4. Нажмите кнопку **"Увімкнути сповіщення"**
5. Браузер покажет диалог разрешения - **нажмите "Разрешить"**

**Ожидаемый результат:**
- Статус изменится на "Сповіщення увімкнено" (зеленая плашка)
- Появится список доступных типов уведомлений с переключателями

---

### 3. Протестировать уведомление о новой заявке

Есть два способа:

#### Способ А: Использовать публичную форму

1. Откройте в **новой вкладке** (или в режиме инкогнито): http://localhost:5173
2. Перейдите на страницу публичной формы (если она доступна локально)
3. Заполните и отправьте заявку

**ИЛИ** используйте curl:

```bash
curl -X POST http://localhost:8000/public/cases \
  -H "Content-Type: application/json" \
  -d '{
    "basis": "заява",
    "applicant_last_name": "Тестовий",
    "applicant_first_name": "Користувач",
    "applicant_phone": "+380501234567",
    "missing_last_name": "Зниклий",
    "missing_first_name": "Тест",
    "missing_gender": "чоловік",
    "missing_birthdate": "1990-01-01",
    "missing_settlement": "Київ",
    "missing_region": "Київська область"
  }'
```

**Ожидаемый результат:**
- Вы должны получить push-уведомление с текстом: **"Нова заявка з сайту"**
- При клике на уведомление откроется страница заявки

#### Способ Б: Тестовое уведомление через API

В DevTools браузера (F12 → Console) выполните:

```javascript
fetch('/api/push-notifications/test', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
    'Authorization': 'Bearer ' + localStorage.getItem('token')
  },
  body: JSON.stringify({
    title: 'Тестове сповіщення',
    body: 'Це тестове повідомлення для перевірки push-уведомлений',
    url: '/profile'
  })
})
.then(r => r.json())
.then(d => console.log('Test notification sent:', d));
```

---

### 4. Протестировать уведомление о назначении на выезд

1. В CRM создайте **выезд** (Field Search)
2. Добавьте себя как **участника** выезда
3. Вы должны получить push-уведомление: **"Вас призначено на виїзд"**

---

### 5. Управление настройками уведомлений

В профиле, в секции Push-сповіщення:

- **Переключатели** - включить/выключить конкретный тип уведомлений
- **"Вимкнути всі сповіщення"** - полностью отписаться от push

**Тест:** Выключите уведомления о новых заявках, создайте заявку - push не должен прийти.

---

## Проверка в DevTools

### Service Worker

1. Откройте DevTools (F12)
2. Вкладка **Application** → **Service Workers**
3. Должен быть зарегистрирован `service-worker.ts` со статусом **activated**

### Push Subscription

В консоли браузера:

```javascript
navigator.serviceWorker.ready.then(reg => {
  reg.pushManager.getSubscription().then(sub => {
    console.log('Current subscription:', sub);
  });
});
```

Должен вывести объект подписки с `endpoint`, `keys.p256dh`, `keys.auth`.

---

## Проверка Backend логов

В терминале запустите:

```bash
docker-compose -f docker-compose.yml logs -f backend
```

При отправке push-уведомления вы увидите:

```
INFO: Push sent to user 1, subscription 1
```

---

## Troubleshooting

### Проблема 1: Кнопка "Увімкнути сповіщення" не появляется

**Причина:** Push API не поддерживается

**Решение:**
- Используйте Chrome, Firefox или Edge (не Safari < 16.4)
- Проверьте, что открыто http://localhost (или https://)
- В режиме инкогнито push может не работать

---

### Проблема 2: Браузер не показывает диалог разрешения

**Причина:** Разрешение уже было дано или отклонено

**Решение:**
1. Chrome: Кликните на иконку замка/инфо слева от адресной строки
2. Найдите "Notifications" → Сбросьте разрешение или установите "Allow"
3. Перезагрузите страницу

---

### Проблема 3: VAPID public key not found

**Симптом:** Ошибка в консоли при попытке подписаться

**Решение:**
```bash
# Проверить, что backend запущен и ключи в .env
docker-compose -f docker-compose.yml exec backend env | grep VAPID

# Перезапустить backend
docker-compose -f docker-compose.yml restart backend
```

---

### Проблема 4: Service Worker не обновляется

**Решение:**
1. DevTools → Application → Service Workers
2. Нажмите **"Unregister"**
3. Перезагрузите страницу (Ctrl+Shift+R)

---

### Проблема 5: Push приходит, но не открывается нужная страница

**Причина:** Данные notification.data не содержат url

**Проверка в backend:**

Посмотрите в `backend/app/routers/public.py` строку 128:
```python
url=f"/cases/{db_case.id}"
```

Должен быть правильный URL.

---

## Поддерживаемые браузеры на localhost

| Браузер           | Поддержка | Примечания                         |
|-------------------|-----------|-----------------------------------|
| Chrome 90+        | ✅ Да      | Рекомендуется для тестирования    |
| Firefox 90+       | ✅ Да      | Полная поддержка                  |
| Edge 90+          | ✅ Да      | На Chromium, аналогично Chrome    |
| Safari 16.4+      | ⚠️ PWA     | Только для установленных PWA      |
| Safari < 16.4     | ❌ Нет     | Не поддерживает Push API          |

---

## Готово к тестированию! ✅

Теперь вы можете:

1. ✅ Подписаться на push-уведомления
2. ✅ Получать уведомления о новых заявках с сайта
3. ✅ Получать уведомления о назначении на выезд
4. ✅ Управлять настройками уведомлений
5. ✅ Тестировать отправку через API

**Следующий шаг:** Деплой на production (см. `PUSH_NOTIFICATIONS_DEPLOYMENT.md`)
